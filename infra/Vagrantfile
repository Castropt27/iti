# Vagrantfile to provision a minimal infra with an NFS server and an app node
# - nfs-server (192.168.56.10) exports /nfsraid/projeto
# - app-node    (192.168.56.11) mounts the NFS export to /home/vagrant/projetocliente

Vagrant.configure("2") do |config|
  config.vm.box = "debian/bullseye64"

  # NFS server
  config.vm.define "nfs-server" do |nfs|
    nfs.vm.hostname = "nfs-server"
    nfs.vm.network "private_network", ip: "192.168.56.10"
    nfs.vm.synced_folder ".", "/vagrant", disabled: true
    nfs.vm.provision "shell", path: "provision/common.sh"
    nfs.vm.provision "shell", path: "provision/nfs.sh"
  end

  # App node (runs Docker + compose, mounts NFS)
  config.vm.define "app-node" do |app|
    app.vm.hostname = "app-node"
    app.vm.network "private_network", ip: "192.168.56.11"
    # sync project into the VM for convenience
    app.vm.synced_folder "..", "/home/vagrant/projeto", owner: "vagrant", group: "vagrant"
    app.vm.provision "shell", path: "provision/common.sh"
    app.vm.provision "shell", path: "provision/docker.sh"
    # mount the NFS export (retry a few times because network may not be ready immediately)
    app.vm.provision "shell", inline: <<-SHELL
      set -eux
      mkdir -p /home/vagrant/projetocliente
      for i in 1 2 3 4 5; do
        if mountpoint -q /home/vagrant/projetocliente; then
          echo 'Already mounted'
          break
        fi
        echo 'Attempting mount from 192.168.56.10:/nfsraid/projeto'
        mount -t nfs 192.168.56.10:/nfsraid/projeto /home/vagrant/projetocliente && break || sleep 3
      done
      # ensure vagrant owns project mount
      chown -R vagrant:vagrant /home/vagrant/projetocliente || true
    SHELL
  end

  # Provider-specific tweaks
  config.vm.provider "virtualbox" do |vb|
    vb.memory = 2048
    vb.cpus = 2
  end
end
